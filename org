#!/usr/bin/env bash
set -euo pipefail

# --- locate repo (resolve symlinks) -----------------------------------------
SELF="$0"
# BSD readlink lacks -f; use python for portability
REAL="$(python3 -c 'import os,sys; print(os.path.realpath(sys.argv[1]))' "$SELF")"
APPDIR="$(cd "$(dirname "$REAL")" && pwd)"

RUNNER="$APPDIR/runner.ts"
ENTRY="$APPDIR/src/app.ts"

# --- environment -------------------------------------------------------------
# Always expose repo-local helpers first
export PATH="$APPDIR:$APPDIR/scripts:$PATH"

# Ensure bun is discoverable even when PATH is sanitized (non-interactive, sudo)
# 1) Prepend common bun locations
PATH="$HOME/.bun/bin:/usr/local/bin:/usr/bin:$PATH"

# 2) If invoked via sudo, also try the invoking user's bun dir
if [[ -n "${SUDO_USER:-}" ]]; then
  # getent works on Debian/Ubuntu; fallback to /home/<user>
  SUDO_HOME="$(getent passwd "$SUDO_USER" 2>/dev/null | awk -F: '{print $6}')"
  [[ -z "${SUDO_HOME:-}" ]] && SUDO_HOME="/home/$SUDO_USER"
  if [[ -d "$SUDO_HOME/.bun/bin" ]]; then
    PATH="$SUDO_HOME/.bun/bin:$PATH"
  fi
fi
export PATH

# Callerâ€™s working directory (may be overridden)
export ORG_CALLER_CWD="${ORG_CALLER_CWD:-$(pwd)}"
export ORG_ENTRY="$ENTRY"
export ORG_APPDIR="$APPDIR"

# --- resolve bun binary ------------------------------------------------------
# Allow manual override via ORG_BUN or BUN_BIN
BUN_BIN="${ORG_BUN:-${BUN_BIN:-}}"
if [[ -z "${BUN_BIN:-}" ]]; then
  if command -v bun >/dev/null 2>&1; then
    BUN_BIN="$(command -v bun)"
  else
    for p in "$HOME/.bun/bin/bun" "/usr/local/bin/bun" "/usr/bin/bun"; do
      if [[ -x "$p" ]]; then BUN_BIN="$p"; break; fi
    done
  fi
fi

if [[ -z "${BUN_BIN:-}" ]]; then
  echo "org: bun not found. PATH=$PATH" >&2
  exit 127
fi

# Optional debug
if [[ "${ORG_DEBUG:-}" == "1" || "${DEBUG:-}" == "1" ]]; then
  echo "[org] APPDIR=$APPDIR" >&2
  echo "[org] RUNNER=$RUNNER" >&2
  echo "[org] ORG_CALLER_CWD=$ORG_CALLER_CWD" >&2
  echo "[org] bun=$BUN_BIN" >&2
  echo "[org] PATH=$PATH" >&2
fi

# --- run ---------------------------------------------------------------------
# Keep the program's working directory as the caller's CWD.
exec "$BUN_BIN" "$RUNNER" --cwd "$ORG_CALLER_CWD" "$@"
