#!/usr/bin/env bash
# Create a patch for the current /work worktree.
# Writes to: /work/.org/runs/<id>/session.patch
# Fail-fast, no guessing.

set -Eeuo pipefail

ROOT="/work"
[[ -d "$ROOT" ]] || { echo "org-patch-create: /work missing" >&2; exit 2; }
git -C "$ROOT" rev-parse --is-inside-work-tree >/dev/null 2>&1 \
  || { echo "org-patch-create: /work is not a git repo" >&2; exit 2; }

# run directory
mkdir -p "$ROOT/.org/runs"
id="$(date -u +%Y%m%d%H%M%S)-$$"
run_dir="$ROOT/.org/runs/$id"
mkdir -p "$run_dir"

patch="$run_dir/session.patch"

# Produce a binary-safe diff of the working tree against HEAD.
# (We do NOT stage files here; review mode uses a scratch copy.)
git -C "$ROOT" -c color.ui=false --no-pager \
  diff --binary HEAD -- . ":(exclude).org/**" > "$patch" || true

# Ensure the file exists even if empty
: > "$patch"

echo "[org-patch-create] wrote: $patch"
