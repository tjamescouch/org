#!/usr/bin/env bash
# Create a patch for the current session.
# Writes to: /work/.org/runs/<id>/session.patch
# Works in both live and review modes; does not write to the real .git.

set -Eeuo pipefail

ROOT="/work"
mkdir -p "$ROOT/.org/runs"

id="$(date -u +%Y%m%d%H%M%S)-$$"
run_dir="$ROOT/.org/runs/$id"
mkdir -p "$run_dir"
patch="$run_dir/session.patch"

# Choose a repo-aware git that also works when /project/.git is read-only
use_project_git=false
if [[ -d /project/.git ]]; then
  if GIT_DIR=/project/.git GIT_WORK_TREE=/work git rev-parse --git-dir >/dev/null 2>&1; then
    use_project_git=true
  fi
fi

git_repo() {
  if $use_project_git; then
    GIT_DIR=/project/.git GIT_WORK_TREE=/work git -c color.ui=false --no-pager "$@"
  else
    git -C /work -c color.ui=false --no-pager "$@"
  fi
}

# Sanity: ensure we’re in a repo context for tracked diffs
if $use_project_git; then
  GIT_DIR=/project/.git GIT_WORK_TREE=/work git rev-parse --is-inside-work-tree >/dev/null 2>&1 \
    || { echo "org-patch-create: /project is not a git repo" >&2; exit 2; }
else
  git -C /work rev-parse --is-inside-work-tree >/dev/null 2>&1 \
    || { echo "org-patch-create: /work is not a git repo" >&2; exit 2; }
fi

tracked="$run_dir/.tracked.diff"
untracked="$run_dir/.untracked.diff"
: > "$tracked"; : > "$untracked"

# 1) Tracked changes vs HEAD (includes deletes/renames)
git_repo diff --binary -M --no-ext-diff HEAD -- . ":(exclude).org/**" ":(exclude).git/**" >"$tracked" || true

# 2) Untracked additions (no-index; doesn’t touch .git)
mapfile -d '' UNTRACKED < <(git_repo ls-files --others --exclude-standard -z -- . ":(exclude).org/**" ":(exclude).git/**" || true)
if (( ${#UNTRACKED[@]} )); then
  for f in "${UNTRACKED[@]}"; do
    [[ -z "$f" ]] && continue
    git -C "$ROOT" -c color.ui=false --no-pager diff --no-index --binary -- /dev/null "$f" >>"$untracked" || true
  done
fi

# 3) Compose final patch
if [[ -s "$tracked" || -s "$untracked" ]]; then
  cat "$tracked" "$untracked" >"$patch"
else
  : >"$patch"
fi

if [[ -n "${ORG_VERBOSE:-}" ]]; then
  echo "[org-patch-create] wrote: $patch"
fi
