##### ~/.tmux.conf — for tmux 3.4 #####

### Terminal + colors ##########################################################
# Prefer tmux's terminfo; fall back if missing. Enable truecolor.
if-shell 'infocmp -x tmux-256color >/dev/null 2>&1' \
  'set -g default-terminal "tmux-256color"' \
  'set -g default-terminal "xterm-256color"'
set -as terminal-overrides ',xterm-256color:RGB'
set -as terminal-overrides ',tmux-256color:RGB'

set -g assume-paste-time 1
set -g focus-events on
set -g history-limit 100000
set -s escape-time 10

### General behavior ###########################################################
set -g mouse on
set -g status-keys vi
set -g mode-keys vi
set -g renumber-windows on
setw -g aggressive-resize on
setw -g remain-on-exit on
set -g allow-rename off
set -g set-clipboard on          # use OSC 52 when available

# Index from 1 (nicer muscle memory with window numbers)
set -g base-index 1
setw -g pane-base-index 1

### Prefix & essentials ########################################################
unbind C-b
set -g prefix C-a
bind C-a send-prefix
bind r source-file ~/.tmux.conf \; display-message "tmux reloaded"

# New windows/panes inherit cwd of the active pane
bind c new-window  -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind \| split-window -h -c "#{pane_current_path}"

# Quick choose-tree navigator (zoom into chosen)
bind s choose-tree -Zw

# Pane navigation (Ctrl-h/j/k/l) and resize (Alt-h/j/k/l)
bind -n C-h select-pane -L
bind -n C-j select-pane -D
bind -n C-k select-pane -U
bind -n C-l select-pane -R
bind -n M-h resize-pane -L 3
bind -n M-j resize-pane -D 3
bind -n M-k resize-pane -U 3
bind -n M-l resize-pane -R 3

# Window cycling
bind -n S-Left  previous-window
bind -n S-Right next-window

# Kill pane/window with confirm
bind x confirm-before -p "kill-pane #P?"   kill-pane
bind X confirm-before -p "kill-window #W?" kill-window

# Toggle synchronize-panes
bind S setw synchronize-panes \; display-message "synchronize-panes: #{?pane_synchronized,on,off}"

# Popup shell (floating terminal)
bind o display-popup -E -w 90% -h 80% -T "#{session_name}:popup" "$SHELL"

### Copy mode (VI) + clipboard (macOS, Linux, Wayland, WSL) ###################
# Selection keys like Vim
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi V send-keys -X select-line
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# y: copy to *system* clipboard when available; otherwise to tmux buffer
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel \
  'sh -c "cat | { command -v pbcopy >/dev/null && pbcopy \
               || command -v wl-copy >/dev/null && wl-copy \
               || command -v xclip   >/dev/null && xclip -selection clipboard \
               || command -v clip.exe >/dev/null && clip.exe \
               || tmux load-buffer - ; }"'

# PASTE from system clipboard (prefix p)
bind p run-shell 'sh -c "{ command -v pbpaste >/dev/null && pbpaste \
                        || command -v wl-paste >/dev/null && wl-paste \
                        || command -v xclip    >/dev/null && xclip -o -selection clipboard \
                        || command -v powershell.exe >/dev/null && powershell.exe -NoProfile -Command Get-Clipboard; } \
                        | tmux load-buffer - && tmux paste-buffer"'

### Aesthetics #################################################################
set -g status on
set -g status-position bottom
set -g status-interval 5
set -g status-style "bg=#1e1e2e,fg=#cdd6f4"

# Window tabs
setw -g window-status-format          " #[fg=#6c7086]#I #[fg=#bac2de]#W "
setw -g window-status-current-format  " #[bg=#89b4fa,fg=#1e1e2e,bold]#I #W #[default]"
setw -g window-status-separator ""

# Pane borders (show index + command on border; requires tmux ≥3.2)
set -g pane-border-style        "fg=#585b70"
set -g pane-active-border-style "fg=#89b4fa"
set -g pane-border-format " #[fg=#6c7086]#{pane_index} #[fg=#bac2de]#{pane_current_command} "

# Messages/prompts
set -g message-style "bg=#89b4fa,fg=#1e1e2e"
set -g message-command-style "bg=#89b4fa,fg=#1e1e2e"

# Status content (left: session@host, right: load & time)
set -g status-left-length 40
set -g status-right-length 120
set -g status-left  "#[bold]#S #[fg=#6c7086]| #[default]#H "
set -g status-right "#(uptime | sed -E 's/.*load averages?: //') | %Y-%m-%d %H:%M "

### Quality of life ############################################################
# Keep environment sane in new panes
set -g update-environment "DISPLAY SSH_ASKPASS SSH_AGENT_PID SSH_CONNECTION SSH_TTY TERM"
# Clear screen + history (Ctrl-Shift-L in many terminals still works; this is tmux-side)
bind C-l send-keys C-l \; run-shell -b "tmux clear-history"

##### End #####


#Important stuff
set -s exit-empty on
setw -g remain-on-exit off
set -g focus-events off
set -s escape-time 0