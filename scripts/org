#!/usr/bin/env bash
# scripts/org
# Grammar:
#   org                -> console (default)
#   org --ui console   -> console
#   org --ui tmux      -> tmux
#
# No positional 'tmux'/'console' allowed to avoid grammar conflicts.

set -Eeuo pipefail

usage() {
  cat >&2 <<'USAGE'
Usage:
  org
  org --ui console
  org --ui tmux
USAGE
}

mode="console"   # default
rest=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --ui)       shift; [[ "${1-}" != "" ]] || { echo "ERROR: --ui requires tmux|console|rich"; usage; exit 2; }; mode="$1"; shift ;;
    --ui=*)     mode="${1#--ui=}"; shift ;;
    tmux|console|rich)
      echo "ERROR: positional '$1' not supported; use --ui $1" >&2; usage; exit 2 ;;
    -h|--help|help) usage; exit 0 ;;
    *) rest+=("$1"); shift ;;
  esac
done

[[ "${mode}" == "tmux" || "${mode}" == "console" || "${mode}" == "rich"  ]] || { echo "ERROR: --ui must be tmux|console|rich"; exit 2; }

case "${mode}" in
  tmux)    exec /usr/local/libexec/org/launch-tmux    "${rest[@]}" ;;
  rich)    exec /usr/local/libexec/org/launch-console "${rest[@]} --ui rich" ;;
  console) exec /usr/local/libexec/org/launch-console "${rest[@]} --ui console" ;;
esac
